<html>
  <head>
    <title>fastet</title>
<style>
.stkn {  
  border: 1px solid; 
  position: relative; 
}
.cell {
  position: absolute;  
}
.whcell {
  background-color: white;
  border: 1px solid #eee;  
}
.blcell {
  background-color: #f7f7f7;
  border: 1px solid #eee;  
}
.grcell {
  background-color: #efe;
  border: 1px solid #eee;  
}

</style>
<script type="text/javascript" src="http://yandex.st/jquery/1.8.3/jquery.js"></script>
<script>
//12:25 - start;

var ncol = 10,
    nrow = 15,
    stkn = [],
    actv = [],
    size = 30,
    $stkn,
    timer,
    delay = 500,
    cellClasses = ['whcell', 'blcell', 'grcell']
    figs = [
            [[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],  
            [[0,0,0,0],[0,0,1,0],[0,0,1,0],[0,1,1,0]],  
            [[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],  
           ];

    
function init(){
  $stkn = $('.stkn');
  
  $stkn.width(size * ncol);
  $stkn.height(size * nrow);
  makeAllCells($stkn);
  
  actv = getAddition(actv, getNewFig());

  updateAll(stkn, actv);
  var timer = setInterval(loop, delay);

  $(document).keydown(onKeyDown);
}

function loop() {
  checkNextMove(move(actv, 0, 1));
}

function checkNextMove(newActv) {
  var inters = 0,
      oldarr = $.extend(true, [], actv);;
  
  inters = updateAll(stkn, actv);

  if (!newActv || inters) { // couldn't move down or active intersect stkn

    if (inters) actv = move(actv, 0, -1); //

    stkn = getAddition(stkn, actv);
    updateAll(stkn, actv);

    actv = getAddition([], getNewFig());
    updateAll(stkn, actv);

  } else {
    actv = newActv;
  }
}

function onKeyDown(e) {
  var newActv;

  switch(e.keyCode) {
    case 37:  // left
      newActv = move(actv, -1, 0)
      break;
    case 39:  // right
      newActv = move(actv, 1, 0)
      break;
    case 38:  // up
      newActv = turn(actv, 1)
      break;
    case 40:  // down
      newActv = turn(actv, -1)
      break;

    case 32:  // spacebar
      newActv = move(actv, 0, 1)
      break;
  }  
  checkNextMove(newActv);
}

function move(arr, xoff, yoff) {
  var i,
      cell,
      coll,
      outarr = $.extend(true, [], arr); // copy by value

  if (xoff < 0) {
    coll = outarr.shift();
    for (i=0; i < nrow; i++) {
      if (coll[i]) return arr
    }
    outarr.push(coll);
  }

  if (xoff > 0) {
    coll = outarr.pop();
    for (i=0; i < nrow; i++) {
      if (coll[i]) return arr
    }    
    outarr.unshift(coll);
  }
 
  if (yoff > 0) {
    for (i=0; i < ncol; i++) {
      cell = outarr[i].pop();
      if (cell) return false
      outarr[i].unshift(cell);
    }
  }  

  if (yoff < 0) {
    for (i=0; i < ncol; i++) {
      cell = outarr[i].shift();
      if (cell) return false
      outarr[i].push(cell);
    }
  } 

  return outarr;
}

function turn(arr, direction) {
  /*
      only rude draft of future func
  */

  var i,
      j,
      outarr = [];

  for (i=0; i < ncol; i++) {
    outarr[i] = [];
    for (j=0; j < ncol; j++) {
      outarr[i][j] = arr[j][i];
    }    
  }

  return outarr;
}

function getAddition(targ, src) {
  var i,
      j,
      result = [],
      offsetx = 0;

  if (src.length == 4) { //src arrays, is new figure
    offsetx = Math.floor(ncol / 2) - 2 ;
  }
  
  for (i=0; i < ncol; i++) {
    result[i] = [];
    for (j=0; j < nrow; j++) {
      if (targ[i] && targ[i][j]) {
        result[i][j] = 1;
      } else {
        if (i >= offsetx && src[i- offsetx] && src[i- offsetx][j]) {
          result[i][j] = 1;  
        } else {
          result[i][j] = 0;
        }
      }
    }    
  }
  return result;
}

function getNewFig() {
  var max = 3,
      min = 0,
      n = Math.floor(Math.random() * (max - min)) + min;

  return figs[n];
}

function update(i, j, v){
    var $cell = $('.cell' + i + '-' + j);
 
    $cell.removeClass(cellClasses.join(' '));
    $cell.addClass(cellClasses[v]); 
}

function updateAll(stk, act){
  var i,
      j,
      intersection = 0;

  for (i=0; i < ncol; i++) {
    for (j=0; j < nrow; j++) {
      var active = act[i] && act[i][j] ? 2 : 0;

      if (stk[i] && stk[i][j]) {
        update(i,j, 1);
        intersection = intersection + active;
      } else {
        update(i,j, active);
      }
    }    
  }
  return intersection;
}

function makeAllCells($container){
  var i,j;

  for (i=0; i < ncol; i++) {
    for (j=0; j < nrow; j++) {
      var cls = 'cell' + i + '-' + j + ' whcell cell',
          $newcell = $( "<div class='" + cls + "'></div>" ),
          l  = i * size,
          t  = j * size;

      $newcell.width(size)
              .height(size)
              .css({'left' : l, 'top' : t});

      $container.append($newcell);
    }    
  }
}

$(document).ready(function() {
  init();
});


</script>

  </head>
<body>

<div class="stkn"></div>

</body>
</html>