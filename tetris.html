<html>
  <head>
    <title>fastet</title>
<style>
.stkn {  
  border: 1px solid; 
  position: relative; 
}
.cell {
  position: absolute;  
}
.whcell {
  background-color: white;
  border: 1px solid #ddd;  
}
.blcell {
  background-color: #aaa;
  border: 1px solid #ddd;  
}
.grcell {
  background-color: #afas;
  border: 1px solid #ddd;  
}
.gameover {
	display: none;
	padding: 10px;
	border: 1px blue dashed;
	border-radius: 5px;
	margin: 10px 0;
}

</style>
<script type="text/javascript" src="http://yandex.st/jquery/1.8.3/jquery.js"></script>
<script>

var ncol = 10,
    nrow = 20,
    stkn = [],
    size = 25,
    $stkn,
    timer,
    delay = 500,
    cellClasses = ['whcell', 'blcell', 'grcell'],
    fig = {
      type: 0,
      turn: 0,
      x   : 0,
      y   : 0,
    },
	score = 0,
	$score,
	$gameover,
    figoffsetx,
    // Array[figType][figTurn][col][row]
    figs = [[
            [[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],  // fig l

            [[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],  

            [[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],  

            [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]  
           ],[
            [[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]], // fig z
			
            [[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]],  

            [[0,0,1,0],[0,1,1,0],[0,1,0,0],[0,0,0,0]],  

            [[0,0,0,0],[0,1,1,0],[0,0,1,1],[0,0,0,0]]  
           ],[
            [[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]], // fig o
			
            [[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],  

            [[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]],

            [[0,1,1,0],[0,1,1,0],[0,0,0,0],[0,0,0,0]]  
           ],[
            [[0,1,0,0],[0,1,0,0],[0,1,1,0],[0,0,0,0]], // fig L
			
            [[0,0,0,0],[1,1,1,0],[1,0,0,0],[0,0,0,0]],  

            [[0,0,0,0],[0,1,1,0],[0,0,1,0],[0,0,1,0]],  

            [[0,0,0,0],[0,0,1,0],[1,1,1,0],[0,0,0,0]]  
           ]
		   
	     ];

    
function init(){
  $stkn = $('.stkn');
  $score = $('.score');
  $gameover = $('.gameover');
  

  $stkn.width(size * ncol);
  $stkn.height(size * nrow);

  figoffsetx = Math.floor(ncol / 2) - 2 ;
  $(document).keydown(onKeyDown);

  startNewGame();  
}

function startNewGame() {
  $gameover.hide();
  score = 0;
  stkn = prepareAllCells($stkn);
  fig = getNewFig();

  drawAllCells(getAddition(stkn, fig).arr);
  updateScore();
  
  timer = setInterval(function() {
            move(0, 1);
          }, delay);  
}

function onKeyDown(e) {
  switch(e.keyCode) {
    case 37:  // left
      move(-1, 0);
      break;
    case 39:  // right
      move(1, 0);
      break;
    case 38:  // up
      turn(1);
      break;
    case 40:  // down
      turn(-1);
      break;

    case 32:  // spacebar
      move(0, 1);
      break;
  }  
}

function holdThisFigAndGetNext() {
    stkn = getAddition(stkn, fig).arr;
    fig = getNewFig();

	if (getAddition(stkn, fig).intersect) {
		gameOver();
	}
    drawAllCells(stkn);
	removeFullLines(checkLines());
}

function gameOver(){
	clearTimeout(timer);
	$('.gameover').show();	
	$('.gameover').one('click', startNewGame);		
}

function removeFullLines(lines){
  var i;

  switch(lines.length) {
    case 1: 
      score += 100;
      break;
    case 2:
	  score += 300;
      break;
    case 3:
	  score += 700;
      break;
    case 4:
	  score += 1500;
      break;
  } 
  
  for (var e in lines) {
	for (i=0; i < ncol; i++) {
	  stkn[i].splice(lines[e], 1);
      stkn[i].unshift(0);
	}
  }
  drawAllCells(stkn);
  updateScore();
}

function checkLines() {
  var i,
      j, 
      res = [],
      cnt;

    for (j=0; j < nrow; j++) {
	  cnt = 0;	
	  for (i=0; i < ncol; i++) {
		if (stkn[i][j] > 0) cnt++;
	  }    
	  if (cnt == ncol) {
		res.push(j);
	  }	  
	}
	return res;
}

function updateScore() {
  $score.html(score - 0);
}

function move(x, y) {
  var nextFigState = $.extend(true, {}, fig),
      unionObj;

  nextFigState.x += x;
  nextFigState.y += y;

  if (!checkBounds(nextFigState)) return false;

  unionObj = getAddition(stkn, nextFigState);
  if (!unionObj.intersect) {
    fig = nextFigState;
    drawAllCells(unionObj.arr);
  } else {
	if (y == 0) return false;
	holdThisFigAndGetNext();
  }
}

function turn(a) {
  var nextFigState = $.extend(true, {}, fig),
      unionObj;

  nextFigState.turn += a;
  if (nextFigState.turn > 3) nextFigState.turn = 0; 
  if (nextFigState.turn < 0) nextFigState.turn = 3; 

  if (!checkBounds(nextFigState)) return false;

  unionObj = getAddition(stkn, nextFigState);
  if (!unionObj.intersect) {
    fig = nextFigState;
    drawAllCells(unionObj.arr);
  } else {
	return false;
  }  
}

function checkBounds(nextFigState){
  if (isOutOfBoundsX(nextFigState)) {
    return false;
  }  
  if (isOutOfBoundsY(nextFigState)) {
	holdThisFigAndGetNext();
    return false;
  }  
  return true;  
}

function isOutOfBoundsX(figObj) {
  var i,
      j,
      figArr = figs[figObj.type][figObj.turn];

  for (i=0; i < 4; i++) {    
    for (j=0; j < 4; j++) {
      if (figArr[i][j] && i + figObj.x > ncol - 1) return true;
      if (figArr[i][j] && i + figObj.x < 0       ) return true;
    }
  }
  return false;
}

function isOutOfBoundsY(figObj) {
  var i,
      j,
      figArr = figs[figObj.type][figObj.turn];

  for (i=0; i < 4; i++) {    
    for (j=0; j < 4; j++) {
      if (figArr[i][j] && j + figObj.y > nrow - 1) return true;
    }
  }
  return false;
}

function getAddition(targ, figObj) {
  var i,
      j,
      result = $.extend(true, [], targ),
      figArr = figs[figObj.type][figObj.turn],
      intersect = 0,
      nx,
      ny;

  
  for (i=0; i < 4; i++) {    
    nx = i + figObj.x;

    for (j=0; j < 4; j++) {
      ny = j + figObj.y;

      if (nx > -1 && ny > -1 && nx < ncol && ny < nrow) {

        if (targ[nx][ny]) {

          if (figArr[i][j]) {

            result[nx][ny] = 1;
            intersect++;

          }
        } else {
          result[nx][ny] = figArr[i][j];  
        }

      }
    }    
  }
  return {arr: result, intersect: intersect};
}

function getNewFig() {
  return {
    type: Math.floor(Math.random() * 4),
    turn: Math.floor(Math.random() * 4),
    x   : figoffsetx,
    y   : 0,
  };
}

function drawCell(i, j, v){
    var $cell = $('.cell' + i + '-' + j);
 
    $cell.removeClass(cellClasses.join(' '));
    $cell.addClass(cellClasses[v]); 
}

function drawAllCells(stk){
  var i,
      j;

  for (i=0; i < ncol; i++) {
    for (j=0; j < nrow; j++) {
        drawCell(i, j, stk[i] && stk[i][j] ? stk[i][j] : 0);
    }    
  }
}

function prepareAllCells($container){
  var i,
      j, 
      arr = [];

  for (i=0; i < ncol; i++) {
    arr[i] = [];
    for (j=0; j < nrow; j++) {
      arr[i][j] = 0;
      var cls = 'cell' + i + '-' + j + ' cell',
          $newcell = $( "<div class='" + cls + "'></div>" ),
          l  = i * size,
          t  = j * size;

      $newcell.width(size)
              .height(size)
              .css({'left' : l, 'top' : t});

      $container.append($newcell);
    }    
  }
  return arr;
}

$(document).ready(function() {
  init();
});


</script>

  </head>
<body>
<div class="gameover"><h3>Gameover</h3> click to continue</div>
<span class="score_container">Score: <span class="score"></span></span>
<div class="stkn"></div>

</body>
</html>