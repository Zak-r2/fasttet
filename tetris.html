<html>
<head>
    <title>FasTet v1.0</title>
    <style>
		body, html, h3, div, span, input, button {
			font-family: arial,sans-serif;
		}	
        .stkn {
            border: 1px solid;
            position: relative;
        }
		.infoContainer {
			position: absolute;
			left: 300px;
		}        
        .prev {
            border: 1px solid;
            position: relative;
        }        
        .cell {
            position: absolute;
			border: 1px solid #ddd;
        }        
        .whcell {
            background-color: white;
        }	
		.c1 {
		    background-color: #00f0f0;
		}
		.c2 {
		    background-color: #0000f0;
		}
		.c3 {
		    background-color: #f0a000;
		}
		.c4 {
		    background-color: #f0f000;
		}
		.c5 {
		    background-color: #00f000;
		}
		.c6 {
		    background-color: #a000f0;
		}
		.c7 {
		    background-color: #f00000;
		}		        
		.pause {
            display: none;
			z-index: 2;
			background: white;
			position: absolute;
			opacity: 0.7;
			filter: alpha(Opacity=70);
			text-align: center;
			left: 0;
			width: 100%;
			height: 100%;		
		}
        .gameover {
            display: none;
            border: 1px blue dashed;
            border-radius: 5px;
			position: absolute;
			z-index: 3;
			background: white;
			text-align: center;
			left: 0;
			width: 100%;
			height: 100%;			
        }
		.highScoreTable {
			padding-top: 30px;
		}
		.highScoreTable div{
			text-align: right;
			font-size: 20px;		
		}
		.highScoreTable ul {
			list-style-type: none;
			padding: 0;
		}
		.highScoreTable li.marked {
			color: red;
			font-size: 125%;
		}
		.highScoreTable li.title {
			color: #99f;
			border-bottom: solid 1px;
			padding-bottom: 2px;
			margin-bottom: 5px;
		}
		.highScoreTable .scoreVal {
			width: 70px;
		}
		.highScoreTable b {
		    width: 150px;
			display: inline-block;		
		}
		.highScoreTable i {
		    width: 40px;
			color: #99f;
			font-style: normal; 
			display: inline-block;		
			text-align: center;
		}		
		.highScoreTable span {
		    width: 50px;
			display: inline-block;
		}
		.userName {
		    width: 115px;
		}
		.startButton {
			font-size: 32px;
			padding: 10px 20px;		
		}
    </style>
    <script type="text/javascript" src="http://yandex.st/jquery/1.8.3/jquery.js"></script>
    <script>
	(function ($) { 

        var ncol = 10,
            nrow = 20,
            stkn = [],
            size = 25,
            $stkn,
            $prev,
            timer,
            level,
            cellClasses = ['whcell', 'c1', 'c2', 'c3', 'c4', 'c5', 'c6', 'c7'],
            fig = {
                type: 0,
                turn: 0,
                x: 0,
                y: 0
            },
            nextFig,
			fall = false,
			paused = false,
            score = 0,
            linesCnt = 0,
            $score,
            $lines,
            $level,
            $gameover,
			$startButton,
            figoffsetx,
			delaysByLevel = [1000, 850, 750, 550, 400, 300, 250, 200, 100, 50],
			highscore = [],
			storageApiKey = 'b6329695880d73afb2c14e8f57cff67f',
            storageCollection = "fasttetres",
			// Array[figType][figTurn][col][row]
			figs = [[
					[[0,0,1,0],[0,0,1,0],[0,0,1,0],[0,0,1,0]],  // fig l

					[[0,0,0,0],[0,0,0,0],[1,1,1,1],[0,0,0,0]],  

					[[0,1,0,0],[0,1,0,0],[0,1,0,0],[0,1,0,0]],  

					[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]]  
				   ],[
					[[0,0,2,0],[0,2,2,0],[0,2,0,0],[0,0,0,0]], // fig z
					
					[[0,0,0,0],[0,2,2,0],[0,0,2,2],[0,0,0,0]],  

					[[0,0,2,0],[0,2,2,0],[0,2,0,0],[0,0,0,0]],  

					[[0,0,0,0],[0,2,2,0],[0,0,2,2],[0,0,0,0]]  
				   ],[
					[[0,3,0,0],[0,3,3,0],[0,0,3,0],[0,0,0,0]], // fig s
					
					[[0,0,0,0],[0,0,3,3],[0,3,3,0],[0,0,0,0]],  

					[[0,3,0,0],[0,3,3,0],[0,0,3,0],[0,0,0,0]],  

					[[0,0,0,0],[0,0,3,3],[0,3,3,0],[0,0,0,0]]  
				   ],[
					[[0,4,4,0],[0,4,4,0],[0,0,0,0],[0,0,0,0]], // fig o
					
					[[0,4,4,0],[0,4,4,0],[0,0,0,0],[0,0,0,0]],  

					[[0,4,4,0],[0,4,4,0],[0,0,0,0],[0,0,0,0]],

					[[0,4,4,0],[0,4,4,0],[0,0,0,0],[0,0,0,0]]  
				   ],[
					[[0,5,0,0],[0,5,0,0],[0,5,5,0],[0,0,0,0]], // fig L
					
					[[0,0,0,0],[5,5,5,0],[5,0,0,0],[0,0,0,0]],  

					[[0,0,0,0],[0,5,5,0],[0,0,5,0],[0,0,5,0]],  

					[[0,0,0,0],[0,0,5,0],[5,5,5,0],[0,0,0,0]]  
				   ],[
					[[0,0,6,0],[0,0,6,0],[0,6,6,0],[0,0,0,0]], // fig J
					
					[[0,0,0,0],[6,0,0,0],[6,6,6,0],[0,0,0,0]],  

					[[0,0,0,0],[0,6,6,0],[0,6,0,0],[0,6,0,0]],  

					[[0,0,0,0],[6,6,6,0],[0,0,6,0],[0,0,0,0]]  
				   ],[
					[[7,7,7,0],[0,7,0,0],[0,0,0,0],[0,0,0,0]], // fig T
					
					[[0,0,7,0],[0,7,7,0],[0,0,7,0],[0,0,0,0]],  

					[[0,0,0,0],[0,7,0,0],[7,7,7,0],[0,0,0,0]],  

					[[7,0,0,0],[7,7,0,0],[7,0,0,0],[0,0,0,0]]  
				   ]
				   
				 ];


        function init() {
            $stkn = $('.stkn');
            $score = $('.score');
            $gameover = $('.gameover');
            $prev = $('.prev');
            $lines = $('.lines');
            $level = $('.level');
			$startButton = $('.startButton');			

            $prev.width(size * 4);
            $prev.height(size * 4);

            $stkn.width(size * ncol);
            $stkn.height(size * nrow);

            figoffsetx = Math.floor(ncol / 2) - 2;

			loadHighScoreTable();
			$startButton.on('click', startNewGame);		
        }

        function startNewGame() {
            $gameover.hide();
            $startButton.hide();
            score = 0;
            linesCnt = 0;
            level = 0;
            stkn = prepareAllCells($stkn, $prev);
            fig = getNewFig();

            drawAllCells(getAddition(stkn, fig).arr);
            updateScore();
			showHighScoreTable(highscore);

            setSpeed(level);
            $(document).keydown(onKeyDown);
			$(window).blur(function(){
				paused = true;
				move(0, 0);
			});			
        }

        function setSpeed(lvl) {
            if (timer) clearTimeout(timer);
            timer = setInterval(function() {
				if (!paused) move(0, 1);
            }, fall ? 40 : delaysByLevel[lvl]);
        }

        function onKeyDown(e) {
            switch (e.keyCode) {
                case 37: // left
                    move(-1, 0);
                    break;
                case 39: // right
                    move(1, 0);
                    break;
                case 38: // up
                    turn(1);
                    break;
                case 40: // down
                    turn(-1);
                    break;
                case 32: // spacebar				
					fall = true;
					move(0, 1);
                    break;
				case 27: // Esc
                case 80: // "P"					
					paused = !paused;
					move(0, 0);
                    break;
            }
        }

        function holdThisFigAndGetNext() {
            stkn = getAddition(stkn, fig).arr;
            fig = getNewFig();

            if (getAddition(stkn, fig).intersect) {
                gameOver();
                return;
            }
            drawAllCells(stkn);
            removeLines(getFullLinesArray(stkn));
        }

        function removeLines(lines) {
            var i,
				e,
				linesScores = [1, 100, 300, 700, 1500];

            linesCnt += lines.length;

            level = Math.floor(linesCnt / 10);
            if (level > 9) level = 9;

            setSpeed(level);

            score += Math.floor(linesScores[lines.length] * 0.25 * (level + 1));

            for (e in lines) {
                for (i = 0; i < ncol; i++) {
                    stkn[i].splice(lines[e], 1);
                    stkn[i].unshift(0);
                }
            }
            drawAllCells(stkn);
            updateScore();
        }

        function getFullLinesArray(cells) {
            var i,
                j,
                res = [],
                cnt;

            for (j = 0; j < nrow; j++) {
                cnt = 0;
                for (i = 0; i < ncol; i++) {
                    if (cells[i][j] > 0) cnt++;
                }
                if (cnt == ncol) {
                    res.push(j);
                }
            }
            return res;
        }

        function move(x, y) {
            var nextFigState = $.extend(true, {}, fig),
                unionObj;

			$('.pause').toggle(paused);
			if (paused) return;
			
            nextFigState.x += x;
            nextFigState.y += y;
			
			if (fall) {
				nextFigState.y += 1;
				if (getAddition(stkn, nextFigState).intersect || isOutOfBoundsY(nextFigState)) {
					fall = false;
				};				
				nextFigState.y -= 1;
				setSpeed(level);
			}

            if (!checkBounds(nextFigState)) return false;
			
			

            unionObj = getAddition(stkn, nextFigState);
            if (!unionObj.intersect) {
                fig = nextFigState;
                drawAllCells(unionObj.arr);
            } else {
				if (y == 0) return false;
                holdThisFigAndGetNext();
            }
        }

        function turn(a) {
            var nextFigState = $.extend(true, {}, fig),
                unionObj;
			
			if (paused) return;
			
            nextFigState.turn += a;
            if (nextFigState.turn > 3) nextFigState.turn = 0;
            if (nextFigState.turn < 0) nextFigState.turn = 3;

            if (!checkBounds(nextFigState)) return false;

            unionObj = getAddition(stkn, nextFigState);
            if (!unionObj.intersect) {
                fig = nextFigState;
                drawAllCells(unionObj.arr);
            } else {
                return false;
            }
        }

        function checkBounds(nextFigState) {
            if (isOutOfBoundsX(nextFigState)) {
                return false;
            }
            if (isOutOfBoundsY(nextFigState)) {
                holdThisFigAndGetNext();
                return false;
            }
            return true;
        }

        function isOutOfBoundsX(figObj) {
            var i,
                j,
                figArr = figs[figObj.type][figObj.turn];

            for (i = 0; i < 4; i++) {
                for (j = 0; j < 4; j++) {
                    if (figArr[i][j] && i + figObj.x > ncol - 1) return true;
                    if (figArr[i][j] && i + figObj.x < 0) return true;
                }
            }
            return false;
        }

        function isOutOfBoundsY(figObj) {
            var i,
                j,
                figArr = figs[figObj.type][figObj.turn];

            for (i = 0; i < 4; i++) {
                for (j = 0; j < 4; j++) {
                    if (figArr[i][j] && j + figObj.y > nrow - 1) return true;
                }
            }
            return false;
        }

        function getAddition(targ, figObj) {
            var i,
                j,
                result = $.extend(true, [], targ),
                figArr = figs[figObj.type][figObj.turn],
                intersect = 0,
                nx,
                ny;


            for (i = 0; i < 4; i++) {
                nx = i + figObj.x;

                for (j = 0; j < 4; j++) {
                    ny = j + figObj.y;

                    if (nx > -1 && ny > -1 && nx < ncol && ny < nrow) {

                        if (targ[nx][ny]) {

                            if (figArr[i][j]) {

                                result[nx][ny] = 1;
                                intersect++;

                            }
                        } else {
                            result[nx][ny] = figArr[i][j];
                        }
                    }
                }
            }
            return {
                arr: result,
                intersect: intersect
            };
        }

        function getNewFig() {
            var fig = nextFig ? $.extend(true, {}, nextFig) : makeFig();

            nextFig = makeFig();
            drawNextFigHint(nextFig);
            return fig;
        }

        function makeFig() {
            return {
                type: Math.floor(Math.random() * 7),
                turn: Math.floor(Math.random() * 4),
                x: figoffsetx,
                y: 0
            };
        }

        function drawNextFigHint(figObj) {
            var i,
                j,
                fig = figs[figObj.type][figObj.turn];

            for (i = 0; i < 4; i++) {
                for (j = 0; j < 4; j++) {
                    updateCellColor(i, j, fig[i] && fig[i][j] ? fig[i][j] : 0, '.prevcell');
                }
            }
        }

        function updateCellColor(x, y, colorIndex, pefix) {
            var $cell = $(pefix + x + '-' + y);

            $cell.removeClass(cellClasses.join(' '))
				 .addClass(cellClasses[colorIndex]);
        }

        function drawAllCells(stk) {
            var i,
                j;

            for (i = 0; i < ncol; i++) {
                for (j = 0; j < nrow; j++) {
                    updateCellColor(i, j, stk[i] && stk[i][j] ? stk[i][j] : 0, '.cell');
                }
            }
        }

        function prepareAllCells($container, $prev) {
            var i,
                j,
                arr = [];

            for (i = 0; i < ncol; i++) {
                arr[i] = [];
                for (j = 0; j < nrow; j++) {
                    arr[i][j] = 0;
                    var cls = 'cell' + i + '-' + j + ' cell',
                        $newcell = $("<div class='" + cls + "'></div>"),
                        l = i * size,
                        t = j * size;

                    $newcell.width(size)
                        .height(size)
                        .css({
                            'left': l,
                            'top': t
                        });

                    $container.append($newcell);
                }
            }

            for (i = 0; i < 4; i++) {
                for (j = 0; j < 4; j++) {
                    var cls = 'prevcell' + i + '-' + j + ' cell',
                        $newcell = $("<div class='" + cls + "'></div>"),
                        l = i * size,
                        t = j * size;

                    $newcell.width(size)
                        .height(size)
                        .css({
                            'left': l,
                            'top': t
                        });

                    $prev.append($newcell);
                }
            }
            return arr;
        }

        function gameOver() {
            clearTimeout(timer);
            $(document).off('keydown');
			$('.userName').focus(); 
            $('.gameover').show();
            $('.resultContainer').show();
            $('.save').one('click', saveResult);
        }		

        function saveResult() {
			var result = {
				name  :  $('.userName').val(), 
				score : score, 
				lines : linesCnt, 
				level : level
			};
			
			$('.resultContainer').hide();
			
			if (result.name) {
				$.post("https://openws.herokuapp.com/" + storageCollection + "?apiKey=" + storageApiKey, result)
					.done(function(data) {
						loadHighScoreTable(data._id);
					})
					.fail(function() {
						alert( "Error saveing your result" );
						showHighScoreTable(highscore);
					})
					.always(function() {
						
						highscore.push(result);
						$startButton.show();
					});				
			} else {

				$startButton.show();			
			}
		}
		
        function updateScore() {
            $score.html(score);
            $lines.html(linesCnt);
            $level.html(level);
        }
		
		function loadHighScoreTable(highLightId) {
			$.get("https://openws.herokuapp.com/" + storageCollection + "?apiKey=" + storageApiKey)
				.done(function(data) {
					highscore = data;
					showHighScoreTable(highscore, highLightId);
				});
        		
		}
		
		function showHighScoreTable(hscore, highLightId) {
			var i,
				itm,
				$list = $('.highScoreTable ul'),
				highLight,
				results = hscore.sort(function (a, b) {
					return b.score - a.score;
				});
			
			$list.html("<li class=\"title\"><i>#</i><b>Player</b><span class='scoreVal'>score</span><span>lines</span><span>level</span></li>");
			for (i in results) {
				if (i > 9) break;
				
				itm = results[i];
				
				highLight = itm._id && itm._id == highLightId ? 'marked' : '';

				$item = $("<li class='" + highLight + "'><i>" 
									+ (i - 0 + 1) + "</i><b>" 
									+ itm.name + "</b><span class='scoreVal'>" 
									+ itm.score + "</span><span>" 
									+ itm.lines + "</span><span>" 
									+ itm.level + "</span></li>");
				$list.append($item);			
			}			
		}
		
		$(document).ready(function() {
            init();
        });		
		
		/*
			v1.0 TODO			
		
			Bugs:
			* Fig sometimes appear on second row, could be firs		
		*/
	}(jQuery));
    </script>
</head>
<body>
	<div class="infoContainer">
		<div class="prev"></div>
		<div class="score_container">
			Score: <span class="score"></span> 
			Lines: <span class="lines"></span> 
			Level: <span class="level"></span>
		</div>
		<div class="highScoreTable">
			<div>High score</div>
			<ul></ul>
		</div>
		
		<button class="startButton">Start</button>
	</div>
    <div class="stkn">
		<div class="gameover">
			<h3>Gameover</h3>
			<div class="resultContainer">
				Your score:<span class="score"></span>
				<br><p>
				Name <input type="text" class="userName"> 
				<button class="save">Save</button>			
			</div>
		</div>	
		<div class="pause">
			<h3>Pause</h3>			
			<div>press ESC or P to continue</div>
		</div>			
	</div>
</body>
</html>